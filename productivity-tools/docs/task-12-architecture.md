# タスク12: ビュー間連携機能の設計思想と実装の狙い

## 1. UnifiedTaskStore（統合タスクストア）

### 設計の狙い
- **Single Source of Truth**: すべてのビューが参照する唯一のデータソースとして機能
- **楽観的更新**: ユーザー体験を向上させるため、サーバー応答を待たずに即座にUIを更新
- **統一されたCRUD操作**: どのビューからでも同じインターフェースでタスクを操作可能

### 実装のポイント
```typescript
// 楽観的更新の例
createTask: async (data) => {
  const tempTask = { id: `temp-${Date.now()}`, ...data };
  set((state) => ({ tasks: [...state.tasks, tempTask] })); // 即座にUIに反映
  
  const newTask = await repository.create(data);
  set((state) => ({
    tasks: state.tasks.map(t => t.id === tempTask.id ? newTask : t)
  }));
}
```

### ビジネス価値
- レスポンシブなUI体験により、ユーザーの作業効率が向上
- データの一元管理により、ビュー間の不整合を防止
- 将来的なリアルタイム同期機能への拡張が容易

## 2. ViewStore（ビュー状態管理）

### 設計の狙い
- **ビュー固有の状態保持**: 各ビューの展開状態、選択状態、表示設定を永続化
- **シームレスなビュー切り替え**: ユーザーが前の作業状態に即座に戻れる
- **ビュー履歴管理**: ブラウザのような「戻る」機能の実現

### 実装のポイント
```typescript
// ビュー設定のデフォルト値とカスタマイズの統合
getViewSettings: (view) => {
  const customSettings = get().viewSettings[view] || {};
  const defaults = defaultViewSettings[view] || {};
  return { ...defaults, ...customSettings };
}
```

### ビジネス価値
- ユーザーの作業コンテキストを保持し、中断からの復帰を容易に
- 各ビューに最適化された表示設定により、情報の視認性が向上
- 個人の作業スタイルに合わせたカスタマイズが可能

## 3. FilterStore（統一フィルタリング）

### 設計の狙い
- **グローバルフィルタ**: すべてのビューに適用される統一的なフィルタリング
- **フィルタの永続化**: よく使うフィルタ条件を保存・再利用可能
- **プリセット機能**: 「今週の期限」「高優先度」などの便利なフィルタを提供

### 実装のポイント
```typescript
// フィルタの保存と永続化
persist(
  (state) => ({ savedFilters: state.savedFilters }),
  { name: 'filter-store' }
)
```

### ビジネス価値
- 大量のタスクから必要な情報を素早く抽出
- チーム間で共通のフィルタ条件を共有可能（将来実装）
- 作業効率の大幅な向上

## 4. ビューアダプター（データ変換層）

### 設計の狙い
- **データ整合性の保証**: 各ビューの特性を保ちながら、統一モデルとの変換を実現
- **疎結合**: ビュー固有のロジックをアダプターに集約し、他の層への影響を最小化
- **拡張性**: 新しいビューの追加が容易（BaseAdapterを継承するだけ）

### 実装のポイント
```typescript
// TodoAdapter: 完了状態とステータスのマッピング
mapCompletedToStatus(completed: boolean): TaskStatus {
  return completed ? 'done' : 'todo';
}

// KanbanAdapter: ラベルから優先度を推測
inferPriorityFromLabels(labels?: Label[]): TaskPriority {
  if (labels?.some(l => l.name.includes('urgent'))) return 'urgent';
  // ...
}
```

### ビジネス価値
- 各ツールの使い慣れたインターフェースを維持
- データの自動変換により、手動でのデータ入力を削減
- ビュー固有の機能（WBSの階層構造、ガントの依存関係）を保持

## 5. useCrossViewDnD（ドラッグ&ドロップ連携）

### 設計の狙い
- **直感的な操作**: マウス操作だけでタスクをビュー間で移動
- **視覚的フィードバック**: ドラッグ中の状態、ドロップ可能領域を明確に表示
- **データ整合性**: 移動時に必要なデータの自動補完と検証

### 実装のポイント
```typescript
// ビュー固有の変換ルール
const rules = {
  kanban: {
    requiredData: ['laneId'], // カンバンには必ずレーンIDが必要
    transformFn: (task, dropData) => ({
      metadata: { kanban: { laneId: dropData.laneId, position: 0 } }
    })
  },
  gantt: {
    transformFn: (task, dropData) => ({
      startDate: dropData.startDate || new Date(), // 日付がなければ今日
      endDate: dropData.endDate || new Date()
    })
  }
};
```

### ビジネス価値
- 作業の流れを中断させない自然な操作性
- ビュー間でのタスク共有が簡単になり、チーム協業が促進
- ミスを防ぐバリデーションとエラーハンドリング

## アーキテクチャの全体像

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Views)                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │   ToDo   │ │   WBS    │ │ Kanban   │ │  Gantt   │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                 Cross-View DnD Hook                      │
│            (ドラッグ&ドロップ連携層)                    │
└─────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                   View Adapters                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │   Todo   │ │   WBS    │ │ Kanban   │ │  Gantt   │  │
│  │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                    State Stores                          │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │ UnifiedTask  │ │    View      │ │   Filter     │    │
│  │    Store     │ │   Store      │ │   Store      │    │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
└─────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│              Repository Layer (SQLite)                   │
└─────────────────────────────────────────────────────────┘
```

## まとめ

タスク12の実装により、以下の価値を実現：

1. **統一されたデータ管理**: すべてのビューが同じデータを参照し、リアルタイムで同期
2. **柔軟なビュー切り替え**: 作業コンテキストを保持したまま、最適なビューで作業可能
3. **強力なフィルタリング**: 大量のタスクから必要な情報を瞬時に抽出
4. **直感的な操作性**: ドラッグ&ドロップによる自然なタスク管理
5. **高い拡張性**: 新しいビューやフィルタの追加が容易

これらの機能により、非プログラマーでも複雑なプロジェクト管理を効率的に行えるツールとなっています。